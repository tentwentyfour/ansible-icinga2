---
- name: Master - Check if Public Key Infrastructure has been initialized
  become: yes
  stat:
    path: "{{ i2_ca_file }}"
  register: ca_certificate

- name: Master - Create Certificate Authority
  become: yes
  command: icinga2 pki new-ca
  when: (groups['masters']|length == 1 or i2_config_master) and not ca_certificate.stat.exists

- name: Master - Synchronize CA Cert between masters (Fetch)
  become: yes
  fetch:
    src: "{{ i2_ca_path }}/{{ item }}"
    dest: /tmp/trusted_certs/
    flat: yes
  loop: ['ca.crt', 'ca.key']
  when: (groups['masters']|length > 1 and i2_config_master)

- name: Master - Synchronize CA between masters - (Ensure ca directory exists)
  become: yes
  file:
    path: "{{ i2_ca_path }}"
    state: directory
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0700
  when: (groups['masters']|length > 1 and not i2_config_master) and not ca_certificate.stat.exists

- name: Master - Synchronize CA between masters - Copy CA
  become: yes
  copy:
    src: /tmp/trusted_certs/{{ item }}
    dest: "{{ i2_ca_path }}/"
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0644
  loop: ['ca.crt', 'ca.key']
  when: (groups['masters']|length > 1 and not i2_config_master) and not ca_certificate.stat.exists

- name: Master - Ensure Certificate directory exists
  become: yes
  file:
    path: "{{ i2_pki_path }}"
    state: directory
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0700

- name: Master - Create Host Certificate
  become: yes
  command: >
    icinga2 pki new-cert
    --cn {{ i2_hostname }}
    --key {{ i2_pki_path }}/{{ i2_hostname }}.key
    --csr {{ i2_pki_path }}/{{ i2_hostname }}.csr
    --cert {{ i2_pki_path }}/{{ i2_hostname }}.crt
  when: client_certificate.stat.exists is sameas false

- name: Master - Sign Host Certificate
  become: yes
  command: >
    icinga2 pki sign-csr
    --csr {{ i2_pki_path }}/{{ i2_hostname }}.csr
    --cert {{ i2_pki_path }}/{{ i2_hostname }}.crt
  when: client_certificate.stat.exists is sameas false

- name: Master - Link CA into PKI path
  become: yes
  file:
    dest: "{{ i2_pki_path }}/ca.crt"
    src: "{{ i2_ca_path }}/ca.crt"
    state: link
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
  when: client_certificate.stat.exists is sameas false
  notify:
    - restart icinga2

- name: Master - Ensure Global-Templates zone directory exists
  become: yes
  file:
    name: "{{ i2_zones_dir }}/global-templates"
    state: directory
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0755
  when: groups['masters']|length == 1 or i2_config_master

- name: Master - Ensure Master Zone directory exists
  become: yes
  file:
    name: "{{ i2_zones_dir }}/{{ i2_zone }}"
    state: directory
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0755
  when: groups['masters']|length == 1 or i2_config_master

- name: Master - Create Api-Users config file
  become: yes
  blockinfile:
    create: yes
    dest: "{{ i2_zones_dir }}/{{ i2_zone }}/api-users.conf"
    marker: "// {mark} Ansible managed block for {{ item.key }}"
    content: "{{ lookup('template', 'api_users_fragment.j2') }}"
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0644
    directory_mode: 0755
  with_dict: "{{ i2_api_users }}"
  when: i2_config_master and i2_api_users is defined
  notify: reload icinga2

- name: Master - Restart Icinga2 Service on Config Master
  service:
    name: icinga2
    state: started
    enabled: yes
  when: i2_manage_service and i2_config_master

