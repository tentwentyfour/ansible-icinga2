---
# When a --limit is in place only the facts of
# the selected hosts are retrieved and we need
# the facts of the other nodes as they are
# used as defaults of variables used in the
# templates
- name: Gather facts of the other Icinga nodes
  setup:
  ignore_errors: yes
  run_once: yes
  delegate_facts: yes
  delegate_to: "{{ item }}"
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}
  when: hostvars[item].ansible_fqdn is not defined

 # Copying role-vars to host-vars
 # We do this in a loop over all the nodes as we
 # need the variables of other nodes in the templates
 # which we don't get if a --limit is in place
- name: Set default hostvars for Icinga2 masters
  set_fact:
    i2_master: >-
      {{ hostvars[item].i2_master|default(True) }}
    i2_satellite: >-
      {{ hostvars[item].i2_satellite|default(False) }}
  run_once: yes
  delegate_facts: yes
  delegate_to: "{{ item }}"
  loop: "{{ groups[i2_master_group]|default([]) }}"

- name: Set default hostvars for Icinga2 satellites
  set_fact:
    i2_master: >-
      {{ hostvars[item].i2_master|default(False) }}
    i2_satellite: >-
      {{ hostvars[item].i2_satellite|default(True) }}
    i2_parent_zone: >-
      {{ hostvars[item].i2_parent_zone|default('master') }}
  run_once: yes
  delegate_facts: yes
  delegate_to: "{{ item }}"
  loop: "{{ groups[i2_satellite_group]|default([]) }}"

- name: Set default hostvars for all Icinga2 nodes
  set_fact:
    i2_address: >-
      {{ hostvars[item].i2_address|default(hostvars[item].ansible_facts.default_ipv4.address) }}
    i2_api_port: >-
      {{ hostvars[item].i2_api_port|default(i2_api_port) }}
    i2_api_host: >-
      {{ hostvars[item].i2_api_host|default(hostvars[item].ansible_facts.default_ipv4.address) }}
    i2_hostname: >-
      {{ hostvars[item].i2_hostname|default(hostvars[item].ansible_fqdn) }}
    i2_zonename: >-
      {{ hostvars[item].i2_zonename|default(hostvars[item].ansible_fqdn) }}
    i2_templates: >-
      {{ hostvars[item].i2_custom_templates|default({}) }}
    i2_objects: >-
      {{ hostvars[item].i2_custom_objects|default({}) }}
    i2_apply_rules: >-
      {{ hostvars[item].i2_custom_apply_rules|default({}) }}
  run_once: yes
  delegate_facts: yes
  delegate_to: "{{ item }}"
  ignore_errors: yes
  loop: >-
    {{ groups[i2_master_group]|default([])
    + groups[i2_satellite_group]|default([])
    + groups[i2_agent_group]|default([]) }}

- name: RedHat - Check if User desires specific package version
  set_fact:
    i2_package_name: "{{ i2_package_name }}-{{ i2_package_version }}"
  when:
    - i2_package_version|length > 3
    - ansible_os_family == 'RedHat'

- name: Debian - Check if User desires specific package version
  set_fact:
    i2_package_name: "{{ i2_package_name }}={{ i2_package_version }}"
  when:
    - i2_package_version|length > 3
    - ansible_os_family == 'Debian'

- name: Check if Client Certificates exist
  become: yes
  stat:
    path: "{{ i2_pki_file }}"
  register: client_certificate
  tags:
    - nodes
    - config

- name: Check if Client Certificate is signed by our CA
  become: yes
  shell: >-
    openssl x509 -in {{ i2_pki_file }} -noout -text | grep Issuer
  register: certificate_authority
  ignore_errors: yes
  when: not i2_master and client_certificate.stat.exists
  tags:
    - nodes
    - config

- name: Set certificate authority fact
  set_fact:
    i2_certificate_signed_by_ca: yes
  when:
    - certificate_authority.changed
    - "'Icinga CA' in certificate_authority.stdout"
  tags:
    - nodes
    - config

- name: Icingaweb2 (Redhat) - Check if SELinux is enabled
  command: /usr/sbin/getenforce
  register: selinux
  when: ansible_os_family == 'RedHat'
