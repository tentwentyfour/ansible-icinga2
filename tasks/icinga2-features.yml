---
- name: Collect all enabled features
  become: yes
  find:
    paths: "{{ i2_features_enabled_dir }}/"
    patterns: '*.conf'
    file_type: any
  register: feature_lookup
  when:
    - i2_remove_unmanaged_features

- name: Set fact enabled_features
  set_fact:
    enabled_features: "{{ enabled_features|default([]) + [ item.path|regex_replace('^\/etc\/icinga2\/features-enabled\/(.*).conf$', '\\1') ] }}"
  loop: "{{ feature_lookup.files }}"
  when:
    - i2_remove_unmanaged_features

- name: Generate enabled feature configuration
  become: yes
  template:
    src: templates/feature-template.conf.j2
    dest: "{{ i2_features_available_dir }}/{{ item.key }}.conf"
    owner: "{{ i2_user }}"
    group: "{{ i2_group }}"
    mode: 0644
  with_dict: "{{ i2_features }}"
  when:
    - item.value.attributes is defined
  register: generated_features
  notify:
    - restart icinga2

- name: Set features to disable (remove)
  set_fact:
    i2_features: "{{ i2_features|default({}) | combine({ item: false }) }}"
  loop: "{{ enabled_features }}"
  when:
    - enabled_features is defined
    - i2_remove_unmanaged_features
    - item not in i2_features

- name: Enable feature configuration
  become: yes
  icinga2_feature:
    name: "{{ item.key }}"
    state: "{{ 'absent' if item.value is sameas false else 'present' }}"
  with_dict: "{{ i2_features }}"
  notify:
    - restart icinga2
